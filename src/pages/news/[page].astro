---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths({ paginate }) {
  const allCases = await getCollection('cases').catch(() => []);
  const allNews = await getCollection('news').catch(() => []);

  const caseAsNews = allCases
    .filter(entry => !entry.slug.startsWith('_'))
    .map(c => ({
      date: c.data.pubDate,
      title: `【施工事例】${c.data.area}：${c.data.title}`,
      url: `/cases/${c.slug}/`,
      category: '施工事例',
    }));

  const manualNews = allNews.map(n => ({
    date: n.data.pubDate,
    title: n.data.title,
    url: `/news/${n.slug}/`,
    category: n.data.category || 'お知らせ',
  }));

  const sortedNews = [...caseAsNews, ...manualNews].sort(
    (a, b) => b.date.valueOf() - a.date.valueOf()
  );

  return paginate(sortedNews, { pageSize: 9 });
}

const { page } = Astro.props;
---

<BaseLayout exactTitle={`新着情報 - ${page.currentPage}ページ目`}>
  <div class="bg-[#f9faf7] min-h-screen pb-20">
    <section class="bg-white border-b border-gray-100 pt-16 pb-12 mb-8 md:mb-12 text-center">
      <div class="max-w-6xl mx-auto px-5">
        <h1 class="text-3xl md:text-5xl font-bold font-zen text-gray-900 mb-4">新着情報</h1>
        <p class="text-gray-500 text-xs md:text-sm tracking-[0.3em] uppercase opacity-70">News & Topics</p>
      </div>
    </section>

    <div class="max-w-4xl mx-auto px-5">
      <div class="grid gap-4 md:gap-5">
        {page.data.map((item) => (
          <a href={item.url} class="group block bg-white p-6 md:p-8 rounded-2xl shadow-sm hover:shadow-xl transition-all duration-500 border border-gray-100">
            <div class="flex flex-col md:flex-row md:items-center gap-4 md:gap-8">
              <div class="flex items-center gap-4 shrink-0 md:w-48">
                <time class="text-[11px] font-sans text-gray-400 font-bold tracking-widest">
                  {item.date.toLocaleDateString('ja-JP').replace(/\//g, '.')}
                </time>
                <span class={`text-[10px] font-bold px-3 py-1 rounded-full ${
                  item.category === '施工事例' ? 'bg-green-700 text-white' : 'bg-gray-100 text-gray-600 border border-gray-200'
                }`}>
                  {item.category}
                </span>
              </div>
              <h2 class="text-base md:text-lg font-bold font-zen text-gray-800 group-hover:text-green-700 transition-colors leading-relaxed flex-grow">
                {item.title}
              </h2>
              <svg xmlns="http://www.w3.org/2000/svg" class="hidden md:block h-5 w-5 text-gray-200 group-hover:text-green-700 group-hover:translate-x-1 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>

      <nav class="flex justify-center items-center mt-12 md:mt-16 gap-2">
        {page.url.prev ? (
          <a href={page.url.prev} class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-gray-200 text-gray-600 hover:bg-green-700 hover:text-white transition-all">&larr;</a>
        ) : (
          <span class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-50 text-gray-300 border border-gray-100 cursor-not-allowed">&larr;</span>
        )}

        <div class="flex gap-2">
          {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((num) => (
            <a
              href={num === 1 ? "/news/" : `/news/${num}/`}
              class={`w-10 h-10 flex items-center justify-center rounded-lg border font-bold transition-all ${
                page.currentPage === num
                  ? "bg-green-700 border-green-700 text-white shadow-md"
                  : "bg-white border-gray-200 text-gray-600 hover:border-green-700 hover:text-green-700"
              }`}
            >
              {num}
            </a>
          ))}
        </div>

        {page.url.next ? (
          <a href={page.url.next} class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-gray-200 text-gray-600 hover:bg-green-700 hover:text-white transition-all">&rarr;</a>
        ) : (
          <span class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-50 text-gray-300 border border-gray-100 cursor-not-allowed">&rarr;</span>
        )}
      </nav>
    </div>
  </div>
</BaseLayout>