---
/**
 * PriceSimulator: 最終確定版
 * LINE公式ロゴ採用・GoogleフォームID完全適合・問い合わせフォーム自動連携
 */
---

<div class="bg-white rounded-[40px] shadow-2xl overflow-hidden max-w-2xl mx-auto my-12 border border-green-50" id="simulator-container">
  <div class="bg-green-800 p-8 text-white text-center relative">
    <div id="progress-bar" class="absolute bottom-0 left-0 h-1 bg-green-400 transition-all duration-500" style="width: 33.3%;"></div>
    <span class="inline-block bg-green-700 text-[10px] font-bold px-3 py-1 rounded-full mb-3 tracking-widest uppercase">Quick Estimate & Diagnosis</span>
    <h3 id="step-title" class="text-2xl font-bold font-zen">お庭の概算費用シミュレーション</h3>
  </div>

  <iframe name="silent_frame" id="silent_frame" style="display:none;"></iframe>

  <div class="p-8 md:p-12">
    <form 
      action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSf8CxREDTYhosuFs3EIFBMvIG9O-brPdKIDgNuMNBIHf79odQ/formResponse" 
      method="POST" 
      target="silent_frame" 
      id="main-simulation-form"
    >
      <div id="step-1" class="step-panel space-y-10">
        <div class="space-y-6">
          <div class="flex justify-between items-end">
            <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
              <span class="w-6 h-6 bg-green-100 text-green-700 rounded-full flex items-center justify-center text-xs font-bold">1</span>
              お庭の広さを選択
            </label>
            <div class="text-right">
              <span id="area-display" class="text-4xl font-bold text-green-700 font-zen">20</span><span class="text-gray-500 font-bold ml-1">㎡</span>
            </div>
          </div>
          <input type="range" id="area-range" min="5" max="100" step="1" value="20" class="w-full h-3 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-green-700" />
          
          <input type="hidden" name="entry.1831280963" id="google-area-hidden" value="20㎡" />
        </div>

        <div class="space-y-4">
          <p class="text-sm font-bold text-gray-700 flex items-center gap-2">
            <span class="w-6 h-6 bg-green-100 text-green-700 rounded-full flex items-center justify-center text-xs font-bold">2</span>
            現在の状況を選択
          </p>
          <div class="grid grid-cols-2 gap-4">
            <label class="p-4 border-2 border-gray-100 rounded-2xl cursor-pointer hover:bg-green-50 flex flex-col items-center transition-all">
              <input type="radio" name="garden_cond_ui" value="0" checked onchange="updatePrice()" class="w-4 h-4 text-green-700" />
              <span class="text-xs font-bold mt-2">土・砂利</span>
              <span class="text-[10px] text-gray-400">追加費用なし</span>
            </label>
            <label class="p-4 border-2 border-gray-100 rounded-2xl cursor-pointer hover:bg-green-50 flex flex-col items-center transition-all">
              <input type="radio" name="garden_cond_ui" value="2500" onchange="updatePrice()" class="w-4 h-4 text-green-700" />
              <span class="text-xs font-bold text-green-600 mt-2">天然芝あり</span>
              <span class="text-[10px] text-green-500 font-bold">+2,500円/㎡</span>
            </label>
          </div>
        </div>

        <div class="bg-gray-50 rounded-[32px] p-8 text-center border border-gray-100">
          <p class="text-[10px] text-gray-400 font-bold mb-2 tracking-widest uppercase">Estimated Total</p>
          <div class="text-5xl font-bold text-gray-900 font-zen">
            <span class="text-sm font-normal text-gray-400">約</span>
            <span id="total-price-ui">240,000</span>
            <span class="text-lg ml-1">円</span>
          </div>
        </div>

        <button type="button" onclick="changeStep(2)" class="w-full bg-green-700 text-white font-bold py-5 rounded-full shadow-xl hover:bg-green-800 transition-all text-lg">
          次へ：お悩みを教えてください
        </button>
      </div>

      <div id="step-2" class="step-panel hidden space-y-8">
        <p class="text-lg font-bold text-center text-gray-800">今、お庭で一番お困りのことは？</p>
        <div class="space-y-3">
          {[
            "毎週末の草むしりが重労働", 
            "虫（蚊や蜘蛛）が大量に発生する", 
            "子供やペットを泥汚れを気にせず遊ばせたい", 
            "砂利や土で見栄えが良くない", 
            "他社の見積もりが適正か確認したい"
          ].map((text) => (
            <label class="flex items-center p-4 border-2 border-gray-100 rounded-2xl cursor-pointer hover:border-green-100 transition-all">
              <input type="radio" name="entry.1382091290" value={text} class="w-5 h-5 text-green-700" required />
              <span class="ml-3 text-sm font-bold text-gray-700">{text}</span>
            </label>
          ))}
        </div>
        <div class="flex gap-4">
          <button type="button" onclick="changeStep(1)" class="w-1/3 bg-gray-100 text-gray-600 font-bold py-4 rounded-full">戻る</button>
          <button type="submit" onclick="startSubmit()" class="w-2/3 bg-green-700 text-white font-bold py-4 rounded-full shadow-xl hover:bg-green-800">診断を完了する</button>
        </div>
      </div>
    </form>

    <div id="step-3" class="step-panel hidden text-center py-6 space-y-8 animate-fade-in">
      <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto text-3xl">✓</div>
      
      <div>
        <h4 class="text-2xl font-bold text-gray-800 font-zen mb-2">診断ありがとうございました！</h4>
        <p class="text-gray-500 text-sm">シミュレーションの結果、概算費用は</p>
        <div class="text-4xl font-bold text-green-700 font-zen my-2">
          約 <span id="final-price-ui">---</span> 円
        </div>
      </div>

      <div class="space-y-4">
        <p class="text-xs font-bold text-gray-400 tracking-widest uppercase">Next Step: 専門スタッフに相談する</p>
        
        <a href="https://line.me/R/ti/p/@073lvwdr" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-4 bg-[#06C755] text-white font-bold py-5 rounded-full shadow-lg hover:opacity-95 transition-all text-lg">
          <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" alt="LINE" class="w-8 h-8" />
          LINEで写真診断・相談
        </a>

        <a href="/contact/" id="to-contact-form" class="flex items-center justify-center w-full bg-white border-2 border-green-700 text-green-700 font-bold py-5 rounded-full hover:bg-green-50 transition-all text-lg shadow-sm">
          メールフォームで調査依頼
        </a>
      </div>
      
      <p class="text-[10px] text-gray-400 italic">※正確な金額は現地調査後に提示いたします。</p>
    </div>
  </div>
</div>

<script is:inline>
  function updatePrice() {
    const area = document.getElementById('area-range').value;
    const condInput = document.querySelector('input[name="garden_cond_ui"]:checked');
    const condVal = condInput ? parseInt(condInput.value) : 0;
    const condLabel = condVal > 0 ? "天然芝あり" : "土・砂利";
    
    const total = area * (12000 + condVal);
    const formattedTotal = total.toLocaleString();

    // UI更新
    document.getElementById('area-display').innerText = area;
    document.getElementById('total-price-ui').innerText = formattedTotal;
    document.getElementById('final-price-ui').innerText = formattedTotal;

    // Googleフォーム用隠しデータ更新
    document.getElementById('google-area-hidden').value = area + "㎡";

    // 問い合わせフォーム用URL生成（お悩み以外をセット）
    const contactBtn = document.getElementById('to-contact-form');
    if(contactBtn) {
      const params = new URLSearchParams({
        area: area,
        cond: condLabel,
        total: formattedTotal
      });
      contactBtn.href = `/contact/?${params.toString()}`;
    }
  }

  function changeStep(n) {
    document.querySelectorAll('.step-panel').forEach((p, i) => {
      p.classList.toggle('hidden', i !== (n-1));
    });
    document.getElementById('progress-bar').style.width = (n / 3 * 100) + "%";
    
    const titles = ["概算シミュレーション", "最後にお悩みを教えてください", "診断結果"];
    document.getElementById('step-title').innerText = titles[n-1];
  }

  function startSubmit() {
    const problemInput = document.querySelector('input[name="entry.1382091290"]:checked');
    if (problemInput) {
      // 最終出口のURLにお悩みを追加
      const contactBtn = document.getElementById('to-contact-form');
      const url = new URL(contactBtn.href, window.location.origin);
      url.searchParams.set('problem', problemInput.value);
      contactBtn.href = url.pathname + url.search;

      // 裏で送信し、0.5秒後に結果表示へ
      setTimeout(() => changeStep(3), 500);
    }
  }

  document.getElementById('area-range').oninput = updatePrice;
  updatePrice();
</script>

<style>
  input[type='range']::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: 32px; height: 32px;
    background: #15803d; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 50%; cursor: pointer;
  }
  .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>